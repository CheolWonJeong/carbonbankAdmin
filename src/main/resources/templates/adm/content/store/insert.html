<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{adm/layout/admlayour}">
	<th:block layout:fragment="head" th:insert="~{@{/adm/layout/admhead}}"></th:block>
	<script type="text/javascript">
		$(document).ready(function(){
	
			//조회버튼 클릭
	        $('#docSave').on('click', function(event) {
	        	
				console.log("start docSave");//순수한 태그
				
				
				// 사업자 등록번호 필수 체크
				var bisNum = $('#bisNum').val().trim();
				if (bisNum === "") { alert("사업자 등록번호를 입력하세요."); $('#bisNum').focus(); return false; }
				
				// 하이픈 제거
				var bisNumRaw = bisNum.replace(/-/g, '');
				
				var storeNm = $('#storeNm').val().trim();
				if (storeNm === "") { alert("상호를 입력하세요."); $('#storeNm').focus(); return false; }
				
				var storeCeoNm = $('#storeCeoNm').val().trim();
				if (storeCeoNm === "") { alert("대표자 성명을 입력하세요."); $('#storeCeoNm').focus(); return false; }
				
				var storeCellNum = $('#storeCellNum').val().trim();
				if (storeCellNum === "") { alert("휴대폰 번호를 입력하세요."); $('#storeCellNum').focus(); return false; }
				
	        	//파일데이터 추출

				//파일데이터 추출 (중복선언)
				var formData = new FormData();
				
				// 1. storeNoImg 파일 추가
				var storeNoImgFile = $("#storeNoImg")[0].files;
				if (storeNoImgFile.length > 0) {
				    for (var i = 0; i < storeNoImgFile.length; i++) {
				        if (!checkExtension(storeNoImgFile[i].name, storeNoImgFile[i].size)) {
				            return false;
				        }
				        // name을 명확히 지정
				        formData.append("storeNoImgFile", storeNoImgFile[i]);
				    }
				}

				// 2. storeImg 파일 추가
				var storeImgFile = $("#storeImg")[0].files;
				if (storeImgFile.length > 0) {
				    for (var i = 0; i < storeImgFile.length; i++) {
				        if (!checkExtension(storeImgFile[i].name, storeImgFile[i].size)) {
				            return false;
				        }
				        formData.append("storeImgFile", storeImgFile[i]);
				    }
				}	

				
				//formData.append("storeId", $('#storeId').val() );
				formData.append("storeNm", $('#storeNm').val() );
				
				//formData.append("bisNum", $('#bisNum').val() );
				formData.append("bisNum", bisNumRaw); // 하이픈 제거된 값으로 저장
				
				formData.append("storeCeoNm", $('#storeCeoNm').val() );
				formData.append("storeCellNum", $('#storeCellNum').val() );
				
				formData.append("storeAddr", $('#storeAddr').val() );
				formData.append("storeEmail", $('#storeEmail').val() );				

				$.ajax({
	                url : '/adm/store/StoreInfoInsProc'
	                , type : 'POST'
	                , data:formData //보내는데이터 form
	    			, contentType:false //보내는데이터타입 false->"multipart/form-data"로 선언됩니다.
	    			, processData:false //폼데이터가 name=값&name=값 형식으로 자동변경되는 것을 막아줍니다.
	                , beforeSend : function( xhr, settings ) { 
	                }
	                , success : function(data, stauts, request) {
	    				if (data.procInd == "S") {
	    					alert("정상 처리 되었습니다.");
	    					location.href = "/adm/store/StoreInfoMainList.do";
						} else if (data.procInd == "E" || (data.errorId == "dupCellNum" || data.errorId == "dupCellNum") ) {
							alert(data.errorMsg);							
	    				} else {
	    					alert("처리중 오류가 발생 했습니다.");
	    				}
	
	                }
	                , error : function(xhr, status) {
	                    alert('서비스 장애발생 관리자에게 문의해 주십시요');
	                }
	                , complete : function(xhr, status) {
	                    //loadingbar_hide();
	                }    
	            });
	        });
			
			
			
			// 사업자등록번호 숫자만 입력, 자동 하이픈
			$('#bisNum').on('input', function() {
			    let value = $(this).val();
			    // 숫자만 남기기
			    value = value.replace(/[^0-9]/g, '');
			    // 10자리까지만 허용
			    value = value.slice(0, 10);

			    // 자동 하이픈 추가
			    let formatted = value;
			    if (value.length > 3 && value.length <= 5) {
			        formatted = value.slice(0,3) + '-' + value.slice(3);
			    } else if (value.length > 5) {
			        formatted = value.slice(0,3) + '-' + value.slice(3,5) + '-' + value.slice(5);
			    }
			    $(this).val(formatted);
			});			
	        
	    });
	</script>

<body>
<div class="adm-wrap">
	<th:block layout:fragment="header" th:insert="~{@{/adm/layout/admheader}}"></th:block>
	
<div layout:fragment="content">
    <div class="adm-container">
        <header>
            <ul class="top-info">
                <li>
                    <i class="iconfont">account_circle</i><span th:text="${sessInfo.CrbnAdmNm}">홍길동님</span> 님 반갑습니다
                </li>
                <li>
                    <a href="#"><i class="iconfontline">logout</i>로그아웃</a>
                </li>
            </ul>
        </header>
		
        <div class="adm-content">
			<h2>가맹점 관리</h2>
            <div class="board-write mT10">
				<table>
					<colgroup>
                        <col style="width:20%;" />
						<col />
					</colgroup>
					<tbody>

						<tr>
							<th>가맹점 아이디</th>
							<td>&#8251; 아이디는 자동생성 됩니다.</td>
						</tr>
						<tr>
							<th>상호</th>
							<td><input type="text" name="" id="storeNm" class="w90"  /></td>
						</tr>						
						<tr>
							<th>사업자 등록번호</th>
							<td><input type="text" name="" id="bisNum" class="w90"  maxlength="12" autocomplete="off" /></td>
						</tr>						
                        
						<tr>
							<th>비밀번호</th>
							<td>&#8251; 비밀번호는 앱 가입시 생성 가능 합니다다.</td>
						</tr>						
						<tr>
							<th>대표자 명</th>
							<td><input type="text" name="" id="storeCeoNm" class="w90"  /></td>
						</tr>						
						<tr>
							<th>대표자 휴대폰 번호</th>
							<td><input type="text" name="" id="storeCellNum" class="w90"  /></td>
						</tr>						
                        
						<tr>
						    <th>사업자 등록증 이미지</th>
						    <td>
						        <div class="file-input">
						            <label>파일선택<input type="file" onchange="javascript:document.getElementById('file_route1').value=this.value"  id="storeNoImg" accept=".jpg,.png,.gif" ></label>
						            <input type="text" readonly="readonly" title="File Route" id="file_route1" >
						       </div>
						    </td>
						</tr>
						<tr>
						    <th>사업장 이미지</th>
						    <td>
						        <div class="file-input">
						            <label>파일선택<input type="file" onchange="javascript:document.getElementById('file_route2').value=this.value" id="storeImg" accept=".jpg,.png,.gif" ></label>
						            <input type="text" readonly="readonly" title="File Route" id="file_route2"  >
						       </div>
						    </td>
						</tr>
						
						<tr>
							<th>사업장 주소</th>
							<td><input type="text" name="" id="storeAddr" class="w90" /></td>
						</tr>
						<tr>
							<th>대표 Email</th>
							<td><input type="text" name="" id="storeEmail" class="w90" /></td>
						</tr>						
					</tbody>
				</table>
			</div>
			
            <div class="t-center mT40">
                <button type="button" class="btn-grayfill" id="docCancel">취소</button>
                <button type="button" class="btn-blue" id="docSave">등록</button>
			</div>
		</div><!-- //content -->
    <script type="text/javascript" src="/adm/js/common/common.js"></script>
	
	</div><!-- //container -->
</div>
</div><!-- //wrap -->
</body>
</html>
